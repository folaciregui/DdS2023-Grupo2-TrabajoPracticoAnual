<!DOCTYPE html>
<html>
<head>
    <title>Iniciar Sesión</title>
</head>
<body>
<h1>Pagina encargada de Registrar/Iniciar Sesión</h1>
<div id="login-form">
    <h1>REGISTRARSE</h1>
    <input type="email" id="emailRegister" placeholder="Correo Electrónico">
    <input type="password" id="passwordRegister" placeholder="Contraseña">
    <button onclick="register()">Registrarse</button>
    <h1>LOGUEARSE</h1>
    <input type="email" id="emailLogin" placeholder="Correo Electrónico">
    <input type="password" id="passwordLogin" placeholder="Contraseña">
    <button onclick="loginWeb()">Iniciar Sesión</button>
    <button onclick="loginGoogle()">Iniciar Sesión con google</button>
    <h1 id="userState"></h1>

</div>

<div id="user-info" style="display: none;">
    <p>Bienvenido, <span id="user-displayname"></span> (Estado email:<span id="user-email"></span> :<span id="texto-verificado"></span>)</p>
    <button onclick="logout()">Cerrar Sesión</button>
    <p>¿Olvidaste tu contraseña? <span onclick="reestablecerPassword()">Haz clic aquí</span></p>
    <button onclick="abrirIncidente()">Abrir Incidente</button>
    <button onclick="cerrarIncidente()">Cerrar Incidente</button>
    <button onclick="consultarIncidentes()">Consultar incidentes</button>

</div>

<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
<!-- <script src="https://www.gstatic.com/firebasejs/9.6.5/firebase-database.js"></script> -->
<!-- ... Otros scripts de Firebase, como storage, messaging, functions, y analytics, si los necesitas ... -->

<script>
    var provider = new firebase.auth.GoogleAuthProvider();
    const firebaseConfig = {
        apiKey: "AIzaSyCqXg0sZXtSOxHPEjkKKS0S4jdHER1z-VU",
        authDomain: "dds-sistema-monitoreables.firebaseapp.com",
        projectId: "dds-sistema-monitoreables",
        storageBucket: "dds-sistema-monitoreables.appspot.com",
        messagingSenderId: "625925036616",
        appId: "1:625925036616:web:8a61a46d81a4c752b9167d"
    };

    // Inicializa Firebase
    firebase.initializeApp(firebaseConfig);
    // Manejo base de datos
    //  const database = firebase.database();
    // const ref = database.ref('/ruta/a/tu/datos'); // Reemplaza con la ruta de tus datos
    //
    // ref.on('value', (snapshot) => {
    //     const data = snapshot.val();
    //     // Procesa y muestra los datos en tu página web
    // });

    // Verifica estado de sesion
    firebase.auth().onAuthStateChanged((user) => {
        if (user) {
            // User is signed in, see docs for a list of available properties
            var uid = user.uid;
            var textoVerificado="";
            document.getElementById("userState").innerHTML="Hizo login"
            console.log(user);//para ver datos de usuario, despues borrar esta linea
            if(user.emailVerified){
                textoVerificado="Estas verificado";
            }else {
                textoVerificado="No estas verificado"
            }
            document.getElementById("texto-verificado").textContent = textoVerificado;
        } else {
            // User is signed out
            document.getElementById("userState").innerHTML="Deslogueado"

        }
    });

    // Referencias a elementos HTML
    const loginForm = document.getElementById("login-form");
    const userInfo = document.getElementById("user-info");
    const userDisplayName = document.getElementById("user-displayname");
    const userEmail = document.getElementById("user-email");

    // Función para registarse
    function register(){
        const email = document.getElementById("emailRegister").value;
        const password = document.getElementById("passwordRegister").value;
        firebase.auth().createUserWithEmailAndPassword(email, password)
            .catch(function(error){
                var errorCode = error.code;
                var errorMessage = error.message;
                alert(errorMessage);
            })
            .then(function (){
                verificarCorreo()
            })
    }
    // Función para iniciar sesión
    function verificarCorreo(){
        var user = firebase.auth().currentUser;
        user.sendEmailVerification().then(function (){
            //Email mandado
        }).catch(function (error){
            // Hubo algun error, manejarlo
        })
    }
    function loginWeb() {
        const email = document.getElementById("emailLogin").value;
        const password = document.getElementById("passwordLogin").value;
        alert("el email es: " + email + " y la password es: " + password);

        firebase.auth().signInWithEmailAndPassword(email, password)
            .then((userCredential) => {
                const user = userCredential.user;
                inicioSesion();
            })
            .catch((error) => {
                alert("Error al iniciar sesión: " + error.message);
            });
    }
    function loginGoogle(){
        firebase.auth().signInWithPopup(provider)
            .then((result) => {
                //capaz es util mas adelante
                var credential = result.credential;
                var token = credential.accessToken;
                var user = result.user;
                inicioSesion();
            }).catch((error) => {
                //manejar errores
            var errorCode = error.code;
            var errorMessage = error.message;
            var email = error.email;
            var credential = error.credential;
        });
    }
    function inicioSesion(){
        loginForm.style.display = "none";
        userInfo.style.display = "block";
        userDisplayName.innerText = user.displayName;
        userEmail.innerText = user.email;
    }
    // Función para cerrar sesión
    function logout() {
        firebase.auth().signOut().then(() => {
            loginForm.style.display = "block";
            userInfo.style.display = "none";
        }).catch((error) => {
            alert("Error al cerrar sesión: " + error.message);
        });
    }
    function reestablecerPassword(){
        const email = document.getElementById("emailLogin").value;
        console.log("llegue loco");
        firebase.auth().sendPasswordResetEmail(email)
            .then(() => {
                // Password reset email sent!
                alert("Revisa tu casilla de correo y utiliza el link para reestablecer la contraseña");
                console.log("actua");
            })
            .catch((error) => {
                var errorCode = error.code;
                var errorMessage = error.message;
                // ..
            });
    }
    function abrirIncidente(){

    }
    function cerrarIncidente(){

    }
    function consultarIncidentes(){

    }
</script>
</body>
</html>
