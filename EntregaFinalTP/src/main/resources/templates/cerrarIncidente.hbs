<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <link rel="icon" type="image/x-icon" href="/img/logoUTN.png">
    <link rel="stylesheet" href="/css/cerrarIncidente.css">
    <link rel="preconnect" href="https://fonts.gstatic.com">
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@500&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@300&display=swap" rel="stylesheet">
    <title>Cerrar Incidente PRUEBAA</title>
</head>
<body style="margin: 0 ; padding: 0 ; text-align: center ; background-image: url('/img/subte2.jpg') ; background-size: cover">
<header style="background-color: rgba(255,255,255,0.5) ; text-align: left ; display: flex; flex-direction: row">
    <img class= "logoUTN" src="/img/logoUTN.png" alt="Imagen en color" style=" text-align: left"></img>
    <div style="align-items: center; flex: 1; text-align: right; margin-top: 20px;">
        <a class="boton" href="pagina-inicio.html" style="text-decoration: none; background-color: #4300d2; color: #ffffff;" onmouseover="this.style.backgroundColor='rgba(255,255,255,0.5)'; this.style.color='#4300d2'" onmouseout="this.style.backgroundColor='#4300d2'; this.style.color='#fff'">Cerrar Sesión</a>
        <a class="botonMenu" href="pagina-principal.html" style="text-decoration: none; background-color: #4300d2; color: #ffffff;" onmouseover="this.style.backgroundColor='rgba(255,255,255,0.5)'; this.style.color='#4300d2'" onmouseout="this.style.backgroundColor='#4300d2'; this.style.color='#fff'">Volver al menu</a>
        <h1 class="titulo">Cerrar incidente</h1>
    </div>
</header>

<div id="app" class="contenedorColumna" style="background: rgba(255,255,255,0.5)">
    <div class="columna1" style="background: none">
        <div class="contenedorColumna1">
            <a class="referencia" href="cargar-datos-entidades.html">Cargar datos Entidades y Organismos</a>
            <a class="referencia" href="abrir-incidente.html">Abrir Incidente</a>
            <a class="referenciaElegida" href="cerrar-incidente.html">Cerrar Incidente</a>
            <a class="referencia" href="consultar-incidente.html">Consultar Incidente</a>
            <a class="referencia" href="sugerencia-incidente.html">Sugerencia Incidente</a>
            <a class="referencia" href="visualizacion-rankings.html">Rankings</a>
            <a class="referencia" href="mi-cuenta.html">Mi cuenta</a>
        </div>
    </div>
    <div class="columna2" style="background: none">
        <div id= "filtrosIncidentes">
            <div class="opciones">
                <label class="label" for="selectEntidad">Selecciona Negocio o Transporte:</label>
                <table class="table table-striped table-hover" style="background: none">
                    <tr style="background: none">
                        <th style="background: rgba(101,101,101,0.66)">ENTIDAD</th>
                        <th style="background: rgba(101,101,101,0.66)"></th>
                    </tr>
                    <tbody>
                    <tr v-for="entidad in entidades" :key="entidad.id" @click="seleccionarEntidad(entidad)">
                        <td class="list">
                            <li>
                                <span v-text="entidad.nombre"></span>
                            </li>
                        </td>
                    </tr>
                    </tbody>
                </table>
            </div>
            <div style="height: 10px"></div>
            <div class="opciones">
                <label class="label" for="selectEstablecimiento">Selecciona la estacion o sucursal:</label>
                <ul>
                    <li v-for="establecimiento in establecimientos" :key="establecimiento.id" @click="seleccionarEstablecimiento(establecimiento)">
                        <span v-text="establecimiento.nombre"></span>
                    </li>
                </ul>
            </div>
            <div style="height: 10px"></div>

            <button class="boton" @click="filtrarIncidentes()">Filtrar incidentes</button>
        </div>
        <div id="areaIncidentes" style="display: none">
            <div class="opciones">
                    <label class="label" for="selectEstablecimiento">Incidentes:</label>
                  <ul>
                    <li v-for="incidente in incidentes" :key="incidente.id"  @click="seleccionarIncidente(incidente)">
                        <span v-text="incidente.id"></span>
                    </li>
                </ul>
            </div>
            <button class="boton" @click="cerrarIncidente()">Cerrar Incidente</button>
            <button class="boton" @click="volverAFiltrar()">Atras</button>
        </div>


        <!--<button class="boton" @click="cerrarIncidente">Cerrar incidente</button>-->
    </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/vue@2"></script>


<script src="https://cdn.jsdelivr.net/npm/vue@2/dist/vue.js"></script>
<script>
    new Vue({
        el: '#app',
        data: {
            entidadSeleccionada: '',
            establecimientoSeleccionado: '',
            servicioSeleccionado: '',

            establecimientos: [],
            servicios: [],
            incidentes: [],
            incidenteSeleccionado: '',
            entidades: [], //   cargar las
            establecimientosFiltrados:[] ,
            serviciosFiltrados:[],
        },
        methods: {
            seleccionarIncidente(incidenteId){
                this.incidenteSeleccionado = incidenteId;
            },
            seleccionarServicio(servicioId){
                this.servicioSeleccionado = servicioId;
            },
            seleccionarEntidad(entidadId) {
                this.entidadSeleccionada = entidadId; // Actualiza la entidad seleccionada
                this.actualizarEstablecimientos(); // Carga los establecimientos relacionados con la entidad seleccionada
                establecimientosFiltrados = this.establecimientosFiltrados();
            },
            seleccionarEstablecimiento(establecimientoId) {
                this.establecimientoSeleccionado = establecimientoId;
                this.actualizarServicios();
                this.serviciosFiltrados=this.serviciosFiltrados();//agregado
            },
            establecimientosFiltrados() {
                return this.establecimientos.filter(establecimiento => establecimiento.entidad.nombre === this.entidadSeleccionada.nombre);

            },

            serviciosFiltrados() {
                console.log("entre a filtrar");
                return this.servicios.filter(servicio => servicio.establecimiento === this.establecimientoSeleccionado);
            },

            actualizarEstablecimientos() {
                // Hacer un fetch para obtener los establecimientos de la entidad seleccionada
                fetch(`http://localhost:8080/api/entidades/${this.entidadSeleccionada.id}/establecimientos`)
                        .then(response => response.json())
                        .then(establecimientos => {
                            console.log(establecimientos);
                            this.establecimientos = establecimientos;
                            this.establecimientoSeleccionado = ''; // Resetear la selección
                            this.servicios = []; // Resetear la lista de servicios
                        })
                        .catch(error => {
                            console.error('Error en la solicitud de los establecimientos:', error);
                            alert(`Hubo un error en la solicitud al buscar los establecimientos:\n\n${error.message}`);
                        });


            },

            actualizarServicios() {//trae todo los servicios luego los filtro
                // Hacer un fetch para obtener los servicios del establecimiento seleccionado
                fetch(`http://localhost:8080/api/establecimientos/${this.establecimientoSeleccionado.id}/servicios`)
                        .then(response => response.json())
                        .then(servicios => {
                            console.log(servicios);
                            this.servicios = servicios;
                        })
                        .catch(error => {
                            console.error('Error en la solicitud de los servicios:', error);
                            alert(`Hubo un error en la solicitud al buscar los servicios:\n\n${error.message}`);
                        });
            },
            actualizarIncidenteEnBD(incidenteId) {

                    fetch(`/api/incidentes/${incidenteId}`, {//capaz cambiar esto
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(this.incidenteSeleccionado)
                    })
                    .then(response => {
                        if (response.ok) {
                            console.log('Incidente actualizado en la base de datos');
                        } else {
                            console.error('Error al actualizar el incidente en la base de datos (else):', response.status);
                        }
                    })
                 .catch(error => {
                    console.error('Error al actualizar el incidente en la base de datos:', error);
                });
            },
            filtrarIncidentes(){
                document.getElementById("filtrosIncidentes").style.display="none";
                document.getElementById("areaIncidentes").style.display="block";
                fetch(`http://localhost:8080/api/incidentesFiltrados/${this.entidadSeleccionada.id}/${this.establecimientoSeleccionado.id}`)
                        .then(response => response.json())
                        .then(incidentes => {
                            console.log(incidentes);
                            this.incidentes = incidentes;
                        })
                        .catch(error => {
                            console.error('Error en la solicitud de los servicios:', error);
                            alert(`Hubo un error en la solicitud al buscar los servicios:\n\n${error.message}`);
                        });

            },
            cerrarIncidente() {
                this.actualizarIncidenteEnBD(this.incidenteSeleccionado.id)
                console.log("cerrando incidente");
            },
            volverAFiltrar(){
                document.getElementById("filtrosIncidentes").style.display="block";
                document.getElementById("areaIncidentes").style.display="none";
            }
        },
        mounted() {
            fetch(`http://localhost:8080/api/entidades`)
                    .then(response => {
                        if (response.status >= 400) {
                            alert("Hubo un error en el API")
                        } else {
                            return response.json()
                        }
                    })
                    .then(entidades => {
                        console.log(entidades);
                        console.log(entidades[0].nombre);
                        // entidades.forEach(entidad);
                        // const nombresEntidades = entidades.map(entidad => entidad.nombre);
                        this.entidades = entidades;
                    })
                    .catch(error => {
                        console.error('Error en la solicitud:', error);
                        alert(`Hubo un error en la solicitud con fetch entidades:\n\n${error.message}`);
                    });

        }
    });
</script>
</body>
</html>